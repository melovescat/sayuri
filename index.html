<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Emoji Sound Generator (High-Expression)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for mobile responsiveness and aesthetics */
        :root {
            --primary-color: #10b981; /* Emerald 500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .main-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .card {
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 480px;
            width: 100%;
            padding: 2rem;
            border-radius: 1.5rem;
            transition: transform 0.3s ease;
        }
        .input-box {
            font-size: 2.5rem;
            text-align: center;
            border: 2px solid #e5e7eb;
            transition: border-color 0.3s;
        }
        .input-box:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .button-primary {
            background-color: var(--primary-color);
            transition: background-color 0.2s, transform 0.1s;
        }
        .button-primary:hover:not(:disabled) {
            background-color: #059669;
        }
        .button-primary:active:not(:disabled) {
            transform: scale(0.98);
        }
        .button-primary:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }
        .loader-ring {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide audio player, since we're using SpeechSynthesis */
        #audio-player {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="main-container">
        <div class="card space-y-6">
            <h1 class="text-3xl font-bold text-center text-gray-800">ðŸŽ¶ AI Emoji Sound Mixer</h1>
            <p class="text-center text-gray-500">Enter 1 to 10 emojis. AI generates the expressive phonetic script, and your browser speaks it!</p>

            <!-- Input Field -->
            <div>
                <input
                    type="text"
                    id="emoji-input"
                    maxlength="20" 
                    placeholder="ðŸš€ðŸ’¥ðŸ¶"
                    class="input-box w-full p-4 rounded-xl shadow-inner"
                />
            </div>

            <!-- Action Button -->
            <button
                id="generate-button"
                onclick="handleGenerateClick()"
                class="button-primary w-full text-white font-semibold py-3 rounded-xl flex items-center justify-center shadow-lg hover:shadow-xl transition"
            >
                <span id="button-text">Generate and Speak Sound</span>
                <div id="loader" class="loader-ring hidden ml-3"></div>
            </button>

            <!-- Status and Audio Player -->
            <div id="status-container" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <p class="text-sm font-medium text-gray-700">Status:</p>
                <p id="message" class="text-base text-gray-600">App ready. Enter emojis!</p>
                <audio id="audio-player"></audio> <!-- Kept for compatibility, but hidden by CSS -->
            </div>

            <div id="tts-note" class="text-xs text-center text-gray-400 mt-4">
                (Note: Audio is generated by your browser's native Text-to-Speech engine, which is unlimited but has limited sound effect quality.)
            </div>
        </div>
    </div>

    <script>
        // WARNING: This key is hardcoded. Use only for testing purposes.
        const API_KEY = "AIzaSyDoFppOFbZakN8HVQr6w28bnkXibSnRvw0"; 
        const GEMINI_FLASH_MODEL = "gemini-2.5-flash-preview-09-2025";
        
        const input = document.getElementById('emoji-input');
        const button = document.getElementById('generate-button');
        const messageDisplay = document.getElementById('message');
        const loader = document.getElementById('loader');

        // --- API Helpers with Exponential Backoff ---

        async function fetchWithRetries(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    
                    if (response.status === 429 && i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}. Body: ${errorBody}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                }
            }
        }

        // --- Core LLM Function (API Call 1) ---

        /**
         * Uses Gemini Flash to determine the combined phonetic sound for the emoji sequence.
         */
        async function getEmojiSoundPhonetics(emojiSequence) {
            // UPDATED PROMPT: Instructs the AI to focus on extreme vocal imitation and performance to push TTS limits.
            const systemPrompt = "You are an award-winning voice actor specializing in exaggerated, non-verbal sound effects. The user provides an emoji sequence. Your *only* output must be a single, highly expressive phonetic performance script that imitates the collective, characteristic sounds of the emojis. Use long vowels, aggressive consonants, and hyphenation to create sound texture. The output must be spoken as a sound effect, not a description. Maximum 50 characters. Do not use punctuation or commentary. Examples: 'ðŸ˜­' -> 'Auuuugh-Waahhh', 'ðŸ‘»' -> 'Whoooo-oo-shhh', 'ðŸ’¥ðŸ¶' -> 'KABOOM-woof-GRRRR'";
            const userQuery = `Generate the phonetic sound phrase for this emoji sequence: ${emojiSequence}`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_FLASH_MODEL}:generateContent?key=${API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const response = await fetchWithRetries(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (text) {
                const sanitizedText = text.trim().replace(/[^a-zA-Z\s\-]/g, '').slice(0, 50); 
                if (sanitizedText.length === 0) {
                     throw new Error("AI returned an empty or unreadable sound phrase.");
                }
                return sanitizedText;
            } else {
                throw new Error("Could not determine the emoji's combined sound script. Received unexpected response.");
            }
        }

        // --- Web Speech API Function (Quota-Free Audio) ---

        /**
         * Uses the browser's native SpeechSynthesis API to speak the phonetic sound.
         */
        function speakPhoneticSound(phoneticSound) {
            if ('speechSynthesis' in window) {
                // Clear any previous speech queue
                window.speechSynthesis.cancel(); 

                const utterance = new SpeechSynthesisUtterance(phoneticSound);
                
                // ADJUSTED: Use more extreme rate and pitch for a dramatic sound effect
                utterance.rate = 2.0; // Very fast rate
                utterance.pitch = 1.5; // High pitch

                // Find a suitable voice 
                const voices = window.speechSynthesis.getVoices();
                const englishVoice = voices.find(v => v.lang.startsWith('en'));
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }
                
                window.speechSynthesis.speak(utterance);
                return true;
            } else {
                return false;
            }
        }

        // --- Main Controller ---

        async function handleGenerateClick() {
            const inputString = input.value.trim();
            const emojiRegex = /(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/g;
            const emojis = inputString.match(emojiRegex);
            
            if (!emojis || emojis.length === 0 || emojis.length > 10) {
                messageDisplay.textContent = "Please enter 1 to 10 emojis only.";
                return;
            }

            const emojiSequence = inputString;

            // Set UI to loading state
            button.disabled = true;
            document.getElementById('button-text').textContent = 'Generating...';
            loader.classList.remove('hidden');
            messageDisplay.textContent = `Analyzing sequence of ${emojis.length} emojis...`;

            try {
                // 1. Get Combined Phonetics (The only step requiring the API Key)
                messageDisplay.textContent = `1/1: Asking AI for the high-expression sound script for ${emojiSequence}...`;
                const phoneticSound = await getEmojiSoundPhonetics(emojiSequence);
                
                // 2. Speak Sound (Quota-Free step)
                const spoke = speakPhoneticSound(phoneticSound);
                
                if (spoke) {
                    messageDisplay.textContent = `Success! Browser is speaking performance script: "${phoneticSound}" (Rate/Pitch adjusted!)`;
                } else {
                     messageDisplay.textContent = `Error: Browser does not support Web Speech API. Sound script: "${phoneticSound}"`;
                }

            } catch (error) {
                console.error("Generation Error:", error);
                
                let userMessage = `Error: Failed to generate script. ${error.message}. Please try again.`;

                // Custom message for API Errors related to the LLM (first step)
                if (error.message.includes("status: 429")) {
                     userMessage = `Rate Limit Exceeded (Status 429 - Too Many Requests). The AI script generator quota is exhausted. You must wait a few hours or until tomorrow to retry this step.`;
                } else if (error.message.includes("status: 403")) {
                     userMessage = `Authorization Error (Status 403 - Permission Denied): Your key's permission is incorrect for the Gemini service. Please check your key restrictions in Google AI Studio!`;
                } else if (error.message.includes("status: 500")) {
                    userMessage = `Internal Error (Status 500): The AI script generator failed. This is temporary. Try again in a minute.`;
                }

                messageDisplay.textContent = userMessage;

            } finally {
                // Reset UI state
                button.disabled = false;
                document.getElementById('button-text').textContent = 'Generate and Speak Sound';
                loader.classList.add('hidden');
            }
        }
    </script>
</body>
</html>

